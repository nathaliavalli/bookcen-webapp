<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Child Dashboard - BOOKCEN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="../index.html">üìö BOOKCEN</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="profile.html">Profile</a>
                <a class="nav-link" href="#" onclick="logoutUser()">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Welcome Section -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="text-primary">Welcome back, <span id="childName">Reader</span>! üìö</h2>
                <p class="text-muted">Ready to dive into your next adventure?</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <div class="display-4 text-primary mb-2">üìñ</div>
                        <h5 class="card-title">Books to Read</h5>
                        <h3 class="text-primary mb-0" id="booksToRead">Loading...</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <div class="display-4 text-success mb-2">‚úÖ</div>
                        <h5 class="card-title">Books Finished</h5>
                        <h3 class="text-success mb-0" id="booksFinished">Loading...</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <div class="display-4 text-warning mb-2">üí∞</div>
                        <h5 class="card-title">Money Earned</h5>
                        <h3 class="text-warning mb-0" id="moneyEarned">Loading...</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <div class="display-4 text-info mb-2">üî•</div>
                        <h5 class="card-title">Reading Streak</h5>
                        <h3 class="text-info mb-0" id="readingStreak">Loading...</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Reading Assignment -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìö Your Reading List</h5>
                    </div>
                    <div class="card-body" id="readingList">
                        <!-- Books will be loaded here dynamically -->
                        <div class="text-center text-muted">
                            <div class="spinner-border mb-2" role="status"></div>
                            <p>Loading your books...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Chapter Quiz -->
        <div class="row mb-4" id="currentQuizSection" style="display: none;">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h5 class="mb-0 text-warning">üìù Chapter Quiz Ready!</h5>
                    </div>
                    <div class="card-body">
                        <p>You have a quiz ready for <strong id="quizBookTitle">Book Title</strong> - <strong id="quizChapterTitle">Chapter Name</strong></p>
                        <button class="btn btn-warning" onclick="startQuiz()">Start Quiz</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush" id="activityList">
                            <!-- Activity will be loaded here dynamically -->
                            <div class="text-center text-muted">
                                <div class="spinner-border mb-2" role="status"></div>
                                <p>Loading activity...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="modal fade" id="quizModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quizModalTitle">Chapter Quiz</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="quizModalBody">
                    <!-- Quiz questions will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitQuizBtn" onclick="submitQuiz()">Submit Quiz</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase Integration -->
    <script type="module">
        // Import Firebase functions
        import { auth, db, getUserProfile } from '../js/firebase-config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { collection, query, where, getDocs, doc, getDoc, orderBy, limit, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        // Global variables
        let currentUser = null;
        let currentUserProfile = null;
        let currentChildId = null;
        let userAssignments = [];
        let currentQuiz = null;

        // Authentication state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const profile = await getUserProfile(user.uid);
                
                if (profile) {
                    if (profile.type === 'child') {
                        // Direct child login
                        currentChildId = user.uid;
                        currentUserProfile = profile;
                    } else if (profile.type === 'parent') {
                        // Parent switching to child view
                        const childId = sessionStorage.getItem('currentChildId');
                        if (childId) {
                            const childProfile = await getUserProfile(childId);
                            if (childProfile && childProfile.parentId === user.uid) {
                                currentChildId = childId;
                                currentUserProfile = childProfile;
                            } else {
                                alert('Invalid child access');
                                window.location.href = 'parent-dashboard.html';
                                return;
                            }
                        } else {
                            alert('No child selected');
                            window.location.href = 'parent-dashboard.html';
                            return;
                        }
                    }
                    
                    document.getElementById('childName').textContent = currentUserProfile.name || 'Reader';
                    await loadChildDashboard(currentChildId);
                } else {
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // Load child dashboard data
        async function loadChildDashboard(childId) {
            try {
                console.log('Loading dashboard for child:', childId);
                
                await Promise.all([
                    loadAssignments(childId),
                    loadStats(childId),
                    loadActivity(childId)
                ]);
                
            } catch (error) {
                console.error('Error loading child dashboard:', error);
                showError('Error loading dashboard data. Please refresh the page.');
            }
        }

        // Load assignments for the child
        async function loadAssignments(childId) {
            try {
                console.log('Querying assignments for childId:', childId);
                
                const assignmentsQuery = query(
                    collection(db, 'assignments'),
                    where('childId', '==', childId)
                );
                
                const assignmentsSnapshot = await getDocs(assignmentsQuery);
                
                console.log('Found assignments:', assignmentsSnapshot.size);
                
                userAssignments = [];
                assignmentsSnapshot.forEach((doc) => {
                    const assignment = { id: doc.id, ...doc.data() };
                    userAssignments.push(assignment);
                    console.log('Assignment loaded:', assignment);
                });

                displayAssignments();
                
            } catch (error) {
                console.error('Error loading assignments:', error);
                document.getElementById('readingList').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading your books. Please refresh the page.
                    </div>
                `;
            }
        }

        // Display assignments in the UI
        function displayAssignments() {
            const readingListContainer = document.getElementById('readingList');
            
            if (userAssignments.length === 0) {
                readingListContainer.innerHTML = `
                    <div class="text-center text-muted">
                        <h5>üìñ No Books Assigned Yet</h5>
                        <p>Your parent hasn't assigned any books yet. Ask them to add some books for you!</p>
                    </div>
                `;
                return;
            }

            let assignmentsHtml = '';
            
            userAssignments.forEach((assignment) => {
                const progressWidth = assignment.progress || 0;
                const isCompleted = assignment.status === 'completed';
                const statusClass = isCompleted ? 'border-success bg-success bg-opacity-10' : 'border-primary';
                const statusBadge = isCompleted ? 
                    '<span class="badge bg-success fs-6">‚úÖ Completed!</span>' : 
                    '<span class="badge bg-primary fs-6">üìñ Reading</span>';
                
                assignmentsHtml += `
                    <div class="card mb-3 ${statusClass}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h5 class="card-title mb-1">${assignment.bookTitle || 'Unknown Book'}</h5>
                                    <p class="text-muted mb-2">by ${assignment.bookAuthor || 'Unknown Author'}</p>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar bg-primary" role="progressbar" 
                                             style="width: ${progressWidth}%" 
                                             aria-valuenow="${progressWidth}" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                    <small class="text-muted">${progressWidth}% Complete</small>
                                </div>
                                <div class="col-md-4 text-end">
                                    ${statusBadge}
                                    <div class="mt-2">
                                        <span class="badge bg-warning">üí∞ $${assignment.totalReward || 0} Reward</span>
                                    </div>
                                    <div class="mt-2">
                                        ${isCompleted ? 
                                            '<button class="btn btn-success btn-sm" disabled>Finished! üéâ</button>' :
                                            `<button class="btn btn-primary btn-sm" onclick="openBook('${assignment.id}')">Continue Reading</button>`
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            ${assignment.chapters ? `
                                <div class="mt-3">
                                    <h6>üìë Chapters:</h6>
                                    <div class="row">
                                        ${assignment.chapters.map((chapter, index) => `
                                            <div class="col-md-3 mb-2">
                                                <div class="small p-2 border rounded ${chapter.completed ? 'bg-success bg-opacity-25' : 'bg-light'}">
                                                    <strong>Ch. ${chapter.number}:</strong> ${chapter.title}<br>
                                                    <small class="text-success">$${chapter.reward} ${chapter.completed ? '‚úÖ' : ''}</small>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            readingListContainer.innerHTML = assignmentsHtml;
        }

        // Load statistics
        async function loadStats(childId) {
            try {
                let booksToRead = 0;
                let booksFinished = 0;
                let totalEarned = 0;
                
                userAssignments.forEach(assignment => {
                    if (assignment.status === 'completed') {
                        booksFinished++;
                        totalEarned += assignment.totalReward || 0;
                    } else {
                        booksToRead++;
                    }
                });
                
                // Get reading streak from user profile
                const childProfile = await getUserProfile(childId);
                const readingStreak = childProfile?.readingStreak || 0;
                
                // Update display
                document.getElementById('booksToRead').textContent = booksToRead;
                document.getElementById('booksFinished').textContent = booksFinished;
                document.getElementById('moneyEarned').textContent = `$${totalEarned}`;
                document.getElementById('readingStreak').textContent = `${readingStreak} days`;
                
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('booksToRead').textContent = '0';
                document.getElementById('booksFinished').textContent = '0';
                document.getElementById('moneyEarned').textContent = '$0';
                document.getElementById('readingStreak').textContent = '0 days';
            }
        }

        // Load recent activity
        async function loadActivity(childId) {
            try {
                const activityContainer = document.getElementById('activityList');
                
                // Generate activity based on assignments
                let activityHtml = '';
                
                if (userAssignments.length > 0) {
                    const recentAssignment = userAssignments[0];
                    activityHtml += `
                        <div class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">üìö Book Assigned</div>
                                "${recentAssignment.bookTitle}" was assigned by your parent
                            </div>
                            <small class="text-muted">${formatDate(recentAssignment.assignedAt)}</small>
                        </div>
                    `;
                } else {
                    activityHtml = `
                        <div class="list-group-item text-center text-muted">
                            <p>No recent activity. Start reading to see your progress here!</p>
                        </div>
                    `;
                }
                
                activityContainer.innerHTML = activityHtml;
                
            } catch (error) {
                console.error('Error loading activity:', error);
                document.getElementById('activityList').innerHTML = `
                    <div class="alert alert-danger">Error loading activity</div>
                `;
            }
        }

        // Utility functions
        function formatDate(timestamp) {
            if (!timestamp) return 'Recently';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString();
        }

        function showError(message) {
            console.error(message);
            alert(message);
        }

        // Global functions for UI interactions
        window.openBook = function(assignmentId) {
            const assignment = userAssignments.find(a => a.id === assignmentId);
            if (assignment) {
                alert(`Opening "${assignment.bookTitle}"!\n\nThis would typically open a reading interface or chapter selection. Reading progress tracking coming soon!`);
                
                // TODO: Implement reading interface
                // For now, just simulate progress
                // window.location.href = `reading.html?assignment=${assignmentId}`;
            }
        };

        window.startQuiz = function() {
            if (currentQuiz) {
                startChapterQuiz(currentQuiz.assignmentId, currentQuiz.chapterId);
            } else {
                alert('No quiz available at the moment.');
            }
        };

        window.startChapterQuiz = function(assignmentId, chapterId) {
            const assignment = userAssignments.find(a => a.id === assignmentId);
            if (!assignment || !assignment.quizzes || !assignment.quizzes[chapterId]) {
                alert('Quiz not found for this chapter.');
                return;
            }

            const chapter = assignment.chapters.find(c => c.id === chapterId);
            const questions = assignment.quizzes[chapterId];
            
            if (!questions || questions.length === 0) {
                alert('No questions available for this quiz.');
                return;
            }

            // Set up the quiz modal
            const modal = new bootstrap.Modal(document.getElementById('quizModal'));
            document.getElementById('quizModalTitle').textContent = 
                `${assignment.bookTitle} - Chapter ${chapter.number}: ${chapter.title}`;
            
            // Generate quiz HTML
            let quizHtml = '<form id="quizForm">';
            questions.forEach((question, qIndex) => {
                quizHtml += `
                    <div class="mb-4">
                        <h6>Question ${qIndex + 1}: ${question.question}</h6>
                        <div class="ms-3">
                `;
                
                question.options.forEach((option, oIndex) => {
                    if (option && option.trim()) {
                        quizHtml += `
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" 
                                       name="question${qIndex}" value="${oIndex}" 
                                       id="q${qIndex}o${oIndex}">
                                <label class="form-check-label" for="q${qIndex}o${oIndex}">
                                    ${option}
                                </label>
                            </div>
                        `;
                    }
                });
                
                quizHtml += `
                        </div>
                    </div>
                `;
            });
            quizHtml += '</form>';
            
            document.getElementById('quizModalBody').innerHTML = quizHtml;
            
            // Store current quiz info for submission
            window.currentQuizData = {
                assignmentId: assignmentId,
                chapterId: chapterId,
                questions: questions,
                passingScore: assignment.settings?.passingScore || 80
            };
            
            modal.show();
        };

        window.submitQuiz = async function() {
            if (!window.currentQuizData) {
                alert('Quiz data not found.');
                return;
            }

            const form = document.getElementById('quizForm');
            const formData = new FormData(form);
            const answers = [];
            let correctAnswers = 0;
            
            // Collect answers
            window.currentQuizData.questions.forEach((question, qIndex) => {
                const selectedAnswer = formData.get(`question${qIndex}`);
                if (selectedAnswer !== null) {
                    answers.push(parseInt(selectedAnswer));
                    // Check if correct (first option is always correct in your system)
                    if (parseInt(selectedAnswer) === question.correctAnswer || parseInt(selectedAnswer) === 0) {
                        correctAnswers++;
                    }
                } else {
                    answers.push(-1); // No answer selected
                }
            });
            
            // Calculate score
            const totalQuestions = window.currentQuizData.questions.length;
            const scorePercentage = (correctAnswers / totalQuestions) * 100;
            const passed = scorePercentage >= window.currentQuizData.passingScore;
            
            try {
                // Update assignment in Firestore
                const assignmentRef = doc(db, 'assignments', window.currentQuizData.assignmentId);
                const assignment = userAssignments.find(a => a.id === window.currentQuizData.assignmentId);
                
                // Update chapter quiz status
                const updatedChapters = assignment.chapters.map(chapter => {
                    if (chapter.id === window.currentQuizData.chapterId) {
                        return {
                            ...chapter,
                            quizCompleted: true,
                            quizPassed: passed,
                            quizScore: scorePercentage,
                            lastQuizDate: new Date()
                        };
                    }
                    return chapter;
                });
                
                // Calculate new progress
                const completedChapters = updatedChapters.filter(c => c.quizPassed).length;
                const newProgress = (completedChapters / updatedChapters.length) * 100;
                const isBookCompleted = completedChapters === updatedChapters.length;
                
                await updateDoc(assignmentRef, {
                    chapters: updatedChapters,
                    progress: newProgress,
                    status: isBookCompleted ? 'completed' : 'in_progress',
                    lastActivity: new Date()
                });
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('quizModal')).hide();
                
                // Show results
                const resultMessage = passed ? 
                    `üéâ Congratulations! You passed!\n\nScore: ${scorePercentage.toFixed(1)}%\nCorrect: ${correctAnswers}/${totalQuestions}\n\nYou earned ${assignment.chapters.find(c => c.id === window.currentQuizData.chapterId)?.reward || 0}!` :
                    `üòî Not quite there yet!\n\nScore: ${scorePercentage.toFixed(1)}%\nCorrect: ${correctAnswers}/${totalQuestions}\nNeeded: ${window.currentQuizData.passingScore}%\n\nKeep reading and try again!`;
                
                alert(resultMessage);
                
                // Reload dashboard to show updated progress
                await loadChildDashboard(currentChildId);
                
            } catch (error) {
                console.error('Error submitting quiz:', error);
                alert('Error submitting quiz. Please try again.');
            }
        };

        window.logoutUser = async function() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    // Clear session storage
                    sessionStorage.removeItem('currentChildId');
                    await signOut(auth);
                    window.location.href = '../index.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Error logging out');
                }
            }
        };

        // DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Child Dashboard loaded with Firebase!');
        });
        
    </script>
</body>
</html>