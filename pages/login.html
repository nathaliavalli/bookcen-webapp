<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - BOOKCEN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title text-center text-primary mb-4">Login to BOOKCEN</h2>
                        
                        <!-- Demo Instructions -->
                        <div class="alert alert-info">
                            <h6>Quick Demo Setup:</h6>
                            <ol class="mb-0">
                                <li>Click "Setup Demo Data" first (creates parent account)</li>
                                <li>Then use the login buttons below</li>
                            </ol>
                        </div>

                        <!-- Setup Demo Data Button -->
                        <div class="text-center mb-3">
                            <button type="button" class="btn btn-success btn-lg w-100" id="setupDemo">
                                üöÄ Setup Demo Data (Click First!)
                            </button>
                        </div>

                        <hr>

                        <!-- Quick Demo Login Buttons -->
                        <div class="text-center mb-3">
                            <p class="text-muted mb-2">Then Login:</p>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="quickLogin('parent')" id="parentLoginBtn">
                                üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Login as Parent
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="quickLogin('child')" id="childLoginBtn">
                                üëß Login as Child
                            </button>
                        </div>

                        <hr>

                        <!-- Manual Login Form -->
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="userType" class="form-label">I am a:</label>
                                <select class="form-select" id="userType">
                                    <option value="">Choose...</option>
                                    <option value="parent">Parent</option>
                                    <option value="child">Child</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="username" class="form-label">Email</label>
                                <input type="email" class="form-control" id="username" placeholder="Enter email">
                            </div>
                            
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" placeholder="Enter password">
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100 mb-3" id="loginBtn">
                                Manual Login
                            </button>
                        </form>

                        <div class="text-center mt-4">
                            <a href="../index.html">‚Üê Back to Home</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        // Import Firebase functions
        import { auth, db, getUserProfile, createUserProfile } from '../js/firebase-config.js';
        import { signInWithEmailAndPassword, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        let demoSetupComplete = false;

        // Setup demo data button
        document.getElementById('setupDemo').addEventListener('click', async function() {
            await setupDemoData();
        });

        // Setup demo data function
        async function setupDemoData() {
            try {
                showMessage('Setting up demo data...', 'info');
                showLoading('setupDemo', true);

                // Create parent account
                let parentCredential;
                try {
                    parentCredential = await createUserWithEmailAndPassword(auth, 'demo.parent@bookcen.com', 'password123');
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        // Parent already exists, sign in to get the user
                        parentCredential = await signInWithEmailAndPassword(auth, 'demo.parent@bookcen.com', 'password123');
                        showMessage('Demo parent already exists. Creating child...', 'info');
                    } else {
                        throw error;
                    }
                }

                const parentId = parentCredential.user.uid;

                // Create parent profile
                await createUserProfile(parentId, {
                    type: 'parent',
                    email: 'demo.parent@bookcen.com',
                    name: 'Demo Parent'
                });

                // Sign out parent
                await auth.signOut();

                // Create child account
                let childCredential;
                try {
                    childCredential = await createUserWithEmailAndPassword(auth, 'demo.child@bookcen.com', 'password123');
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        showMessage('Demo accounts already exist!', 'success');
                        demoSetupComplete = true;
                        showLoading('setupDemo', false);
                        enableLoginButtons();
                        return;
                    } else {
                        throw error;
                    }
                }

                const childId = childCredential.user.uid;

                // Create child profile
                await createUserProfile(childId, {
                    type: 'child',
                    email: 'demo.child@bookcen.com',
                    name: 'Alex (Demo Child)',
                    parentId: parentId,
                    age: 8,
                    readingLevel: 'Grade 3',
                    favoriteGenre: 'Adventure',
                    gender: 'male',
                    readingStreak: 5,
                    totalRewards: 15
                });

                // Create demo assignments
                await createDemoAssignments(childId, parentId);

                // Sign out child
                await auth.signOut();

                showMessage('‚úÖ Demo data created successfully! Now you can login.', 'success');
                demoSetupComplete = true;
                enableLoginButtons();

            } catch (error) {
                console.error('Setup error:', error);
                showMessage('‚ùå Setup failed: ' + error.message, 'danger');
            } finally {
                showLoading('setupDemo', false);
            }
        }

        // Create demo assignments
        async function createDemoAssignments(childId, parentId) {
            const assignments = [
                {
                    childId: childId,
                    parentId: parentId,
                    bookId: 'book_dogman_1',
                    bookTitle: 'Dog Man: Mothering Heights',
                    bookAuthor: 'Dav Pilkey',
                    totalChapters: 8,
                    rewardPerChapter: 0.75,
                    totalReward: 6.00,
                    status: 'in_progress',
                    progress: 37.5,
                    chaptersCompleted: 3,
                    currentChapter: 4,
                    rewardsEarned: 2.25,
                    rewardsPaid: 0,
                    assignedAt: new Date(),
                    createdAt: new Date()
                },
                {
                    childId: childId,
                    parentId: parentId,
                    bookId: 'book_harry_potter_1',
                    bookTitle: 'Harry Potter and the Philosopher\'s Stone',
                    bookAuthor: 'J.K. Rowling',
                    totalChapters: 17,
                    rewardPerChapter: 0.60,
                    totalReward: 10.20,
                    status: 'in_progress',
                    progress: 12,
                    chaptersCompleted: 2,
                    currentChapter: 3,
                    rewardsEarned: 1.20,
                    rewardsPaid: 0,
                    assignedAt: new Date(),
                    createdAt: new Date()
                }
            ];

            for (const assignment of assignments) {
                await addDoc(collection(db, 'assignments'), assignment);
            }
        }

        // Quick login function
        window.quickLogin = async function(type) {
            if (!demoSetupComplete) {
                alert('Please click "Setup Demo Data" first!');
                return;
            }

            try {
                const email = type === 'parent' ? 'demo.parent@bookcen.com' : 'demo.child@bookcen.com';
                const password = 'password123';

                showLoading(`${type}LoginBtn`, true);
                showMessage(`Signing in as ${type}...`, 'info');

                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const profile = await getUserProfile(user.uid);
                
                if (profile && profile.type === type) {
                    showMessage(`‚úÖ Welcome, ${profile.name}!`, 'success');
                    
                    setTimeout(() => {
                        if (type === 'parent') {
                            window.location.href = 'parent-dashboard.html';
                        } else {
                            window.location.href = 'child-dashboard.html';
                        }
                    }, 1500);
                } else {
                    await auth.signOut();
                    showMessage('‚ùå Profile mismatch or not found', 'danger');
                }

            } catch (error) {
                console.error('Login error:', error);
                showMessage('‚ùå Login failed: ' + error.message, 'danger');
            } finally {
                showLoading(`${type}LoginBtn`, false);
            }
        };

        // Manual login form
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userType = document.getElementById('userType').value;
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!userType || !email || !password) {
                showMessage('Please fill in all fields', 'danger');
                return;
            }

            try {
                showLoading('loginBtn', true);
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                const profile = await getUserProfile(user.uid);
                
                if (profile && profile.type === userType) {
                    showMessage(`Welcome back, ${profile.name}!`, 'success');
                    setTimeout(() => {
                        if (userType === 'parent') {
                            window.location.href = 'parent-dashboard.html';
                        } else {
                            window.location.href = 'child-dashboard.html';
                        }
                    }, 1500);
                } else {
                    await auth.signOut();
                    showMessage('User type mismatch or profile not found', 'danger');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Login failed: ' + error.message, 'danger');
            } finally {
                showLoading('loginBtn', false);
            }
        });

        // Helper functions
        function enableLoginButtons() {
            document.getElementById('parentLoginBtn').disabled = false;
            document.getElementById('childLoginBtn').disabled = false;
            document.getElementById('setupDemo').innerHTML = '‚úÖ Demo Data Ready';
            document.getElementById('setupDemo').disabled = true;
            document.getElementById('setupDemo').classList.remove('btn-success');
            document.getElementById('setupDemo').classList.add('btn-outline-success');
        }

        function showLoading(buttonId, isLoading) {
            const btn = document.getElementById(buttonId);
            if (isLoading) {
                btn.disabled = true;
                if (buttonId === 'setupDemo') {
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Setting up...';
                } else if (buttonId === 'loginBtn') {
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
                } else {
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';
                }
            } else {
                btn.disabled = false;
                if (buttonId === 'setupDemo') {
                    btn.innerHTML = 'üöÄ Setup Demo Data (Click First!)';
                } else if (buttonId === 'loginBtn') {
                    btn.innerHTML = 'Manual Login';
                } else if (buttonId === 'parentLoginBtn') {
                    btn.innerHTML = 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Login as Parent';
                } else if (buttonId === 'childLoginBtn') {
                    btn.innerHTML = 'üëß Login as Child';
                }
            }
        }

        function clearMessages() {
            const existingMessages = document.querySelectorAll('.alert:not(.alert-info):not(.alert-info)');
            existingMessages.forEach(msg => msg.remove());
        }

        function showMessage(message, type) {
            clearMessages();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type} mt-3`;
            messageDiv.innerHTML = message;
            
            const form = document.getElementById('loginForm');
            form.parentNode.insertBefore(messageDiv, form);
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }
        }

        // Check if demo is already setup on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if demo accounts exist
            try {
                const testCredential = await signInWithEmailAndPassword(auth, 'demo.parent@bookcen.com', 'password123');
                await auth.signOut();
                demoSetupComplete = true;
                enableLoginButtons();
                showMessage('Demo data already exists. You can login now.', 'info');
            } catch (error) {
                // Demo not setup yet
                document.getElementById('parentLoginBtn').disabled = true;
                document.getElementById('childLoginBtn').disabled = true;
            }
        });
    </script>
</body>
</html>