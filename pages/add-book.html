<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Book - BOOKCEN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Custom styles for step indicator */
        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step-item.active .step-circle {
            background-color: #007bff;
            color: white;
        }

        .step-line {
            height: 2px;
            background-color: #e9ecef;
            flex-grow: 1;
            margin: 0 20px;
            margin-top: 20px;
        }

        .step-item.active ~ .step-item .step-line {
            background-color: #007bff;
        }

        .book-cover-placeholder {
            width: 120px;
            height: 160px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .placeholder-content {
            text-align: center;
        }

        .chapter-item {
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }

        .chapter-item:hover {
            background-color: #e9ecef;
        }

        .chapter-active {
            border-left-color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.1);
        }

        .question-block {
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }

        .question-block:hover {
            background-color: #e9ecef;
        }

        .reward-preview p {
            margin-bottom: 8px;
        }

        .chapter-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .quiz-tab {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .quiz-tab.active {
            border-color: #007bff;
            background-color: rgba(13, 110, 253, 0.05);
        }

        .child-selection-highlight {
            background-color: #e7f3ff;
            border: 1px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="../index.html">üìö BOOKCEN</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="parent-dashboard.html">‚Üê Back to Dashboard</a>
                <a class="nav-link" href="../index.html">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="text-primary">üìñ Add New Book</h2>
                <p class="text-muted">Assign a new book to your child and create chapter-specific quizzes.</p>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="step-item active" id="step1">
                        <div class="step-circle">1</div>
                        <small>Book Details</small>
                    </div>
                    <div class="step-line"></div>
                    <div class="step-item" id="step2">
                        <div class="step-circle">2</div>
                        <small>Chapter Structure</small>
                    </div>
                    <div class="step-line"></div>
                    <div class="step-item" id="step3">
                        <div class="step-circle">3</div>
                        <small>Chapter Quizzes</small>
                    </div>
                    <div class="step-line"></div>
                    <div class="step-item" id="step4">
                        <div class="step-circle">4</div>
                        <small>Rewards</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <form id="addBookForm">
            <!-- Step 1: Book Details -->
            <div class="step-content" id="stepContent1">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìö Book Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <!-- Child selection will be dynamically inserted here -->
                                
                                <div class="mb-3">
                                    <label for="bookTitle" class="form-label">Book Title *</label>
                                    <input type="text" class="form-control" id="bookTitle" 
                                           placeholder="e.g., Harry Potter and the Sorcerer's Stone" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="bookAuthor" class="form-label">Author *</label>
                                    <input type="text" class="form-control" id="bookAuthor" 
                                           placeholder="e.g., J.K. Rowling" required>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="bookPages" class="form-label">Number of Pages</label>
                                            <input type="number" class="form-control" id="bookPages" 
                                                   placeholder="e.g., 309" min="1">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="readingLevel" class="form-label">Reading Level</label>
                                            <select class="form-select" id="readingLevel">
                                                <option value="">Select level...</option>
                                                <option value="kindergarten">Kindergarten</option>
                                                <option value="grade1">Grade 1</option>
                                                <option value="grade2">Grade 2</option>
                                                <option value="grade3">Grade 3</option>
                                                <option value="grade4">Grade 4</option>
                                                <option value="grade5">Grade 5</option>
                                                <option value="grade6">Grade 6</option>
                                                <option value="middle">Middle School</option>
                                                <option value="high">High School</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="bookGenre" class="form-label">Genre</label>
                                    <select class="form-select" id="bookGenre">
                                        <option value="">Select genre...</option>
                                        <option value="adventure">Adventure</option>
                                        <option value="fantasy">Fantasy</option>
                                        <option value="mystery">Mystery</option>
                                        <option value="science-fiction">Science Fiction</option>
                                        <option value="biography">Biography</option>
                                        <option value="historical">Historical Fiction</option>
                                        <option value="realistic">Realistic Fiction</option>
                                        <option value="non-fiction">Non-Fiction</option>
                                        <option value="poetry">Poetry</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="dueDate" class="form-label">Due Date (Optional)</label>
                                    <input type="date" class="form-control" id="dueDate">
                                    <small class="text-muted">When should your child finish this book?</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <div class="book-cover-placeholder mb-3">
                                        <div class="placeholder-content">
                                            <i class="display-1 text-muted">üìñ</i>
                                            <p class="text-muted">Book Cover</p>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm">
                                        Upload Cover Image
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Chapter Structure -->
            <div class="step-content d-none" id="stepContent2">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìë Chapter Structure</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong>üí° Tip:</strong> Add all the chapters in this book. Each chapter will have its own quiz that your child needs to complete.
                        </div>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="chapterTitle" class="form-label">Chapter Title</label>
                                    <input type="text" class="form-control" id="chapterTitle" 
                                           placeholder="e.g., The Boy Who Lived">
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="chapterNumber" class="form-label">Chapter Number</label>
                                            <input type="number" class="form-control" id="chapterNumber" 
                                                   placeholder="1" min="1" value="1">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="chapterReward" class="form-label">Chapter Reward ($)</label>
                                            <input type="number" class="form-control" id="chapterReward" 
                                                   placeholder="1.00" min="0" step="0.25" value="1.00">
                                        </div>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-primary" onclick="addChapter()">
                                    ‚ûï Add Chapter
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="generateChapters()">
                                    üîÑ Auto-Generate Chapters
                                </button>
                            </div>
                            
                            <div class="col-md-4">
                                <h6>üìã Chapter List</h6>
                                <div class="chapter-list" id="chapterList">
                                    <p class="text-muted text-center">No chapters added yet</p>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        Total Chapters: <span id="totalChapters">0</span><br>
                                        Total Rewards: $<span id="totalRewards">0.00</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Chapter Quizzes -->
            <div class="step-content d-none" id="stepContent3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">‚ùì Create Chapter Quizzes</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Note:</strong> You need to add chapters first. Each chapter will need 3-5 quiz questions.
                        </div>

                        <div id="chapterQuizTabs">
                            <p class="text-muted text-center">Add chapters in the previous step to create quizzes</p>
                        </div>

                        <div id="currentQuizContent" class="mt-4" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 id="currentChapterTitle">Chapter Quiz</h6>
                                <div>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addQuizQuestion()">
                                        ‚ûï Add Question
                                    </button>
                                </div>
                            </div>

                            <div id="quizQuestions">
                                <!-- Questions will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Final Settings & Rewards -->
            <div class="step-content d-none" id="stepContent4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üéÅ Final Settings & Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="passingScore" class="form-label">Passing Score for All Quizzes</label>
                                    <select class="form-select" id="passingScore">
                                        <option value="60">60% (3/5 questions correct)</option>
                                        <option value="70">70% (4/5 questions correct)</option>
                                        <option value="80" selected>80% (4/5 questions correct)</option>
                                        <option value="100">100% (All questions correct)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="maxAttempts" class="form-label">Quiz Attempts Allowed</label>
                                    <select class="form-select" id="maxAttempts">
                                        <option value="1">1 attempt per chapter</option>
                                        <option value="2">2 attempts per chapter</option>
                                        <option value="3" selected>3 attempts per chapter</option>
                                        <option value="unlimited">Unlimited attempts</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="completionBonus" class="form-label">Book Completion Bonus</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="completionBonus" 
                                               placeholder="5.00" min="0" step="0.50" value="5.00">
                                    </div>
                                    <small class="text-muted">Extra reward for completing all chapters</small>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notifyChild" checked>
                                    <label class="form-check-label" for="notifyChild">
                                        Send notification to child about new book assignment
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">üìä Book Summary</h6>
                                        <div class="reward-preview">
                                            <p><strong>Book:</strong> <span id="summaryTitle">Enter book title</span></p>
                                            <p><strong>Author:</strong> <span id="summaryAuthor">Enter author</span></p>
                                            <p><strong>Total Chapters:</strong> <span id="summaryChapters">0</span></p>
                                            <p><strong>Chapter Rewards:</strong> $<span id="summaryChapterRewards">0.00</span></p>
                                            <p><strong>Completion Bonus:</strong> $<span id="summaryBonus">5.00</span></p>
                                            <p><strong>Total Possible:</strong> $<span id="summaryTotal">5.00</span></p>
                                            <p><strong>Passing Score:</strong> <span id="summaryScore">80%</span></p>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <h6>üìù Quiz Summary</h6>
                                    <div id="quizSummary" class="small text-muted">
                                        No quizzes created yet
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" id="prevBtn" onclick="previousStep()" disabled>
                            ‚Üê Previous
                        </button>
                        <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                            Next ‚Üí
                        </button>
                        <button type="submit" class="btn btn-success d-none" id="submitBtn">
                            üéâ Assign Book to Child
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase Integration Script -->
    <script type="module">
        // Import Firebase functions
        import { auth, db, getUserProfile } from '../js/firebase-config.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { 
            collection, 
            addDoc, 
            query, 
            where, 
            getDocs, 
            serverTimestamp,
            doc,
            updateDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        // Global variables
        let currentUser = null;
        let currentUserProfile = null;
        let availableChildren = [];
        let selectedChildId = null;

        // Form state variables
        let currentStep = 1;
        let chapters = [];
        let chapterQuizzes = {};
        let currentQuizChapter = null;

        // Authentication state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const profile = await getUserProfile(user.uid);
                if (profile && profile.type === 'parent') {
                    currentUserProfile = profile;
                    await loadChildrenList(user.uid);
                } else {
                    alert('Access denied. This page is for parents only.');
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // Load children for this parent
        async function loadChildrenList(parentUid) {
            try {
                const childrenQuery = query(
                    collection(db, 'users'), 
                    where('parentId', '==', parentUid),
                    where('type', '==', 'child')
                );
                const childrenSnapshot = await getDocs(childrenQuery);
                
                availableChildren = [];
                childrenSnapshot.forEach((doc) => {
                    availableChildren.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Add child selection to Step 1 if there are multiple children
                if (availableChildren.length > 1) {
                    addChildSelectionToForm();
                } else if (availableChildren.length === 1) {
                    selectedChildId = availableChildren[0].id;
                    showSingleChildInfo();
                } else {
                    // No children found
                    alert('No children found. Please add a child first.');
                    window.location.href = 'parent-dashboard.html';
                    return;
                }

                console.log('Children loaded:', availableChildren);
            } catch (error) {
                console.error('Error loading children:', error);
                alert('Error loading children. Please refresh the page.');
            }
        }

        // Add child selection dropdown to the form
        function addChildSelectionToForm() {
            const bookDetailsCard = document.querySelector('#stepContent1 .card-body .row .col-md-8');
            
            const childSelectionHtml = `
                <div class="child-selection-highlight mb-4">
                    <label for="childSelect" class="form-label fw-bold">üë∂ Assign to Child *</label>
                    <select class="form-select" id="childSelect" required onchange="updateSelectedChild(this.value)">
                        <option value="">Select a child...</option>
                        ${availableChildren.map(child => 
                            `<option value="${child.id}">${child.name} (Age ${child.age || 'Unknown'})</option>`
                        ).join('')}
                    </select>
                    <small class="text-muted">Choose which child will receive this book assignment</small>
                </div>
            `;
            
            bookDetailsCard.insertAdjacentHTML('afterbegin', childSelectionHtml);
        }

        // Show single child info when there's only one child
        function showSingleChildInfo() {
            const bookDetailsCard = document.querySelector('#stepContent1 .card-body .row .col-md-8');
            const child = availableChildren[0];
            
            const childInfoHtml = `
                <div class="child-selection-highlight mb-4">
                    <div class="d-flex align-items-center">
                        <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                            <span class="text-white">${child.gender === 'female' ? 'üëß' : 'üë¶'}</span>
                        </div>
                        <div>
                            <h6 class="mb-1">Assigning to: ${child.name}</h6>
                            <small class="text-muted">Age ${child.age || 'Unknown'} ‚Ä¢ Reading Level: ${child.readingLevel || 'Not set'}</small>
                        </div>
                    </div>
                </div>
            `;
            
            bookDetailsCard.insertAdjacentHTML('afterbegin', childInfoHtml);
        }

        // Update selected child
        window.updateSelectedChild = function(childId) {
            selectedChildId = childId;
            console.log('Selected child:', childId);
        };

        // Save book assignment to Firebase
        async function saveBookToFirebase(bookData) {
            try {
                if (!selectedChildId) {
                    throw new Error('No child selected');
                }

                // Create the assignment document
                const assignmentData = {
                    // Basic book info
                    bookTitle: bookData.title,
                    bookAuthor: bookData.author,
                    bookPages: parseInt(bookData.pages) || null,
                    readingLevel: bookData.level || null,
                    genre: bookData.genre || null,
                    dueDate: bookData.dueDate ? new Date(bookData.dueDate) : null,
                    
                    // Assignment info
                    childId: selectedChildId,
                    parentId: currentUser.uid,
                    assignedAt: serverTimestamp(),
                    status: 'assigned', // assigned, in_progress, completed
                    progress: 0,
                    
                    // Reward settings
                    passingScore: parseInt(bookData.settings.passingScore),
                    maxAttempts: bookData.settings.maxAttempts === 'unlimited' ? null : parseInt(bookData.settings.maxAttempts),
                    completionBonus: parseFloat(bookData.settings.completionBonus),
                    notifyChild: bookData.settings.notifyChild,
                    
                    // Calculate total possible reward
                    totalReward: bookData.chapters.reduce((sum, ch) => sum + ch.reward, 0) + parseFloat(bookData.settings.completionBonus),
                    
                    // Metadata
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                // Save the main assignment
                const assignmentRef = await addDoc(collection(db, 'assignments'), assignmentData);
                console.log('Assignment created with ID:', assignmentRef.id);

                // Save chapters
                const chaptersData = bookData.chapters.map(chapter => ({
                    assignmentId: assignmentRef.id,
                    childId: selectedChildId,
                    chapterNumber: chapter.number,
                    chapterTitle: chapter.title,
                    reward: chapter.reward,
                    status: 'locked', // locked, unlocked, completed
                    attempts: 0,
                    bestScore: 0,
                    quizCompleted: false,
                    createdAt: serverTimestamp()
                }));

                // Save all chapters
                const chapterPromises = chaptersData.map(chapterData => 
                    addDoc(collection(db, 'chapters'), chapterData)
                );
                const chapterRefs = await Promise.all(chapterPromises);
                console.log('Chapters created:', chapterRefs.length);

                // Save quizzes for each chapter
                const quizPromises = [];
                chapterRefs.forEach((chapterRef, index) => {
                    const chapter = bookData.chapters[index];
                    const chapterQuizData = bookData.quizzes[chapter.id] || [];
                    
                    chapterQuizData.forEach((question, questionIndex) => {
                        const questionData = {
                            chapterId: chapterRef.id,
                            assignmentId: assignmentRef.id,
                            childId: selectedChildId,
                            questionNumber: questionIndex + 1,
                            question: question.question,
                            options: question.options.filter(opt => opt.trim() !== ''), // Remove empty options
                            correctAnswerIndex: 0, // First option is always correct as per your design
                            createdAt: serverTimestamp()
                        };
                        
                        quizPromises.push(addDoc(collection(db, 'quiz_questions'), questionData));
                    });
                });

                await Promise.all(quizPromises);
                console.log('Quiz questions created:', quizPromises.length);

                // Unlock the first chapter
                if (chapterRefs.length > 0) {
                    const firstChapterRef = chapterRefs[0];
                    await updateDoc(doc(db, 'chapters', firstChapterRef.id), {
                        status: 'unlocked',
                        updatedAt: serverTimestamp()
                    });
                }

                // Optional: Create notification for child if enabled
                if (bookData.settings.notifyChild) {
                    await createNotificationForChild(selectedChildId, assignmentRef.id, bookData.title);
                }

                return assignmentRef.id;

            } catch (error) {
                console.error('Error saving book to Firebase:', error);
                throw error;
            }
        }

        // Create notification for child (optional)
        async function createNotificationForChild(childId, assignmentId, bookTitle) {
            try {
                const notificationData = {
                    childId: childId,
                    type: 'new_book_assigned',
                    title: 'New Book Assigned! üìö',
                    message: `You have a new book to read: "${bookTitle}". Start reading to earn rewards!`,
                    assignmentId: assignmentId,
                    read: false,
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, 'notifications'), notificationData);
                console.log('Notification created for child');
            } catch (error) {
                console.error('Error creating notification:', error);
                // Don't throw error here, as it's optional
            }
        }

        // Form submission
        document.getElementById('addBookForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Saving to Database...';
            submitBtn.disabled = true;
            
            try {
                if (!selectedChildId) {
                    throw new Error('Please select a child to assign this book to');
                }

                if (!validateCurrentStep()) {
                    throw new Error('Please complete all required fields');
                }
                
                // Collect all form data
                const bookData = {
                    title: document.getElementById('bookTitle').value,
                    author: document.getElementById('bookAuthor').value,
                    pages: document.getElementById('bookPages').value,
                    level: document.getElementById('readingLevel').value,
                    genre: document.getElementById('bookGenre').value,
                    dueDate: document.getElementById('dueDate').value,
                    chapters: chapters,
                    quizzes: chapterQuizzes,
                    settings: {
                        passingScore: document.getElementById('passingScore').value,
                        maxAttempts: document.getElementById('maxAttempts').value,
                        completionBonus: document.getElementById('completionBonus').value,
                        notifyChild: document.getElementById('notifyChild').checked
                    }
                };
                
                // Save to Firebase
                const assignmentId = await saveBookToFirebase(bookData);
                
                // Get selected child name for display
                const selectedChild = availableChildren.find(child => child.id === selectedChildId);
                
                // Show success message
                alert(`üéâ Book "${bookData.title}" successfully assigned to ${selectedChild ? selectedChild.name : 'child'}!\n\n` +
                      `‚úÖ ${chapters.length} chapters created\n` +
                      `‚úÖ ${Object.values(chapterQuizzes).reduce((sum, q) => sum + q.length, 0)} quiz questions added\n` +
                      `üí∞ Total possible rewards: ${(chapters.reduce((sum, ch) => sum + ch.reward, 0) + parseFloat(bookData.settings.completionBonus)).toFixed(2)}\n\n` +
                      `Assignment ID: ${assignmentId}\n` +
                      `${selectedChild ? selectedChild.name : 'Your child'} will receive a notification and can start reading!`);
                
                // Redirect back to dashboard
                setTimeout(() => {
                    window.location.href = 'parent-dashboard.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error saving book:', error);
                alert(`Error saving book: ${error.message}`);
                
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Validation function
        function validateCurrentStep() {
            if (currentStep === 1) {
                const title = document.getElementById('bookTitle').value;
                const author = document.getElementById('bookAuthor').value;
                
                if (!title || !author) {
                    alert('Please fill in the required fields: Book Title and Author');
                    return false;
                }
                
                if (availableChildren.length > 1 && !selectedChildId) {
                    alert('Please select a child to assign this book to');
                    return false;
                }
            } else if (currentStep === 2) {
                if (chapters.length === 0) {
                    alert('Please add at least one chapter');
                    return false;
                }
            } else if (currentStep === 3) {
                for (let chapter of chapters) {
                    const chapterQuestions = chapterQuizzes[chapter.id] || [];
                    if (chapterQuestions.length < 3) {
                        alert(`Please add at least 3 questions for ${chapter.title}`);
                        return false;
                    }
                    
                    // Validate each question has content
                    for (let i = 0; i < chapterQuestions.length; i++) {
                        const question = chapterQuestions[i];
                        if (!question.question.trim()) {
                            alert(`Question ${i + 1} in ${chapter.title} is missing the question text`);
                            return false;
                        }
                        
                        const validOptions = question.options.filter(opt => opt.trim() !== '').length;
                        if (validOptions < 2) {
                            alert(`Question ${i + 1} in ${chapter.title} needs at least 2 answer options`);
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        // Step navigation functions
        window.nextStep = function() {
            if (validateCurrentStep()) {
                currentStep++;
                showStep(currentStep);
                updateStepIndicators();
                updateNavigationButtons();
                
                if (currentStep === 3) {
                    generateChapterQuizTabs();
                }
            }
        };

        window.previousStep = function() {
            currentStep--;
            showStep(currentStep);
            updateStepIndicators();
            updateNavigationButtons();
        };

        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.add('d-none');
            });
            
            document.getElementById(`stepContent${step}`).classList.remove('d-none');
        }

        function updateStepIndicators() {
            document.querySelectorAll('.step-item').forEach((item, index) => {
                if (index + 1 <= currentStep) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');

            prevBtn.disabled = currentStep === 1;
            
            if (currentStep === 4) {
                nextBtn.classList.add('d-none');
                submitBtn.classList.remove('d-none');
            } else {
                nextBtn.classList.remove('d-none');
                submitBtn.classList.add('d-none');
            }
        }

        // Chapter management functions
        window.addChapter = function() {
            const title = document.getElementById('chapterTitle').value;
            const number = parseInt(document.getElementById('chapterNumber').value);
            const reward = parseFloat(document.getElementById('chapterReward').value);
            
            if (!title) {
                alert('Please enter a chapter title');
                return;
            }
            
            const chapterId = `chapter_${number}`;
            const chapter = {
                id: chapterId,
                number: number,
                title: title,
                reward: reward
            };
            
            chapters.push(chapter);
            chapterQuizzes[chapterId] = [];
            
            updateChapterList();
            updateChapterCounters();
            updateSummary();
            
            // Auto-increment for next chapter
            document.getElementById('chapterNumber').value = number + 1;
            document.getElementById('chapterTitle').value = '';
        };

        window.generateChapters = function() {
            const bookTitle = document.getElementById('bookTitle').value;
            if (!bookTitle) {
                alert('Please enter a book title first');
                return;
            }
            
            const chapterCount = prompt('How many chapters does this book have?', '10');
            if (!chapterCount || isNaN(chapterCount)) return;
            
            chapters = [];
            chapterQuizzes = {};
            
            for (let i = 1; i <= parseInt(chapterCount); i++) {
                const chapterId = `chapter_${i}`;
                const chapter = {
                    id: chapterId,
                    number: i,
                    title: `Chapter ${i}`,
                    reward: 1.00
                };
                chapters.push(chapter);
                chapterQuizzes[chapterId] = [];
            }
            
            updateChapterList();
            updateChapterCounters();
            updateSummary();
        };

        window.removeChapter = function(chapterId) {
            chapters = chapters.filter(ch => ch.id !== chapterId);
            delete chapterQuizzes[chapterId];
            
            updateChapterList();
            updateChapterCounters();
            updateSummary();
        };

        function updateChapterList() {
            const listElement = document.getElementById('chapterList');
            
            if (chapters.length === 0) {
                listElement.innerHTML = '<p class="text-muted text-center">No chapters added yet</p>';
                return;
            }
            
            let html = '';
            chapters.forEach(chapter => {
                html += `
                    <div class="chapter-item p-2 mb-2 rounded d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Ch. ${chapter.number}:</strong> ${chapter.title}<br>
                            <small class="text-success">${chapter.reward.toFixed(2)}</small>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" onclick="removeChapter('${chapter.id}')">
                            ‚úï
                        </button>
                    </div>
                `;
            });
            
            listElement.innerHTML = html;
        }

        function updateChapterCounters() {
            const totalChapters = chapters.length;
            const totalRewards = chapters.reduce((sum, ch) => sum + ch.reward, 0);
            
            document.getElementById('totalChapters').textContent = totalChapters;
            document.getElementById('totalRewards').textContent = totalRewards.toFixed(2);
        }

        // Quiz management functions
        window.generateChapterQuizTabs = function() {
            const tabsElement = document.getElementById('chapterQuizTabs');
            
            if (chapters.length === 0) {
                tabsElement.innerHTML = '<p class="text-muted text-center">Add chapters first to create quizzes</p>';
                return;
            }
            
            let html = '<div class="row">';
            chapters.forEach((chapter, index) => {
                const questionsCount = chapterQuizzes[chapter.id].length;
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="quiz-tab p-3 ${index === 0 ? 'active' : ''}" onclick="selectChapterQuiz('${chapter.id}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Ch. ${chapter.number}:</strong> ${chapter.title}
                                </div>
                                <div>
                                    <span class="badge ${questionsCount >= 3 ? 'bg-success' : 'bg-warning'}">${questionsCount} Q's</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            tabsElement.innerHTML = html;
            
            if (chapters.length > 0) {
                selectChapterQuiz(chapters[0].id);
            }
        };

        window.selectChapterQuiz = function(chapterId) {
            currentQuizChapter = chapterId;
            const chapter = chapters.find(ch => ch.id === chapterId);
            
            document.querySelectorAll('.quiz-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.quiz-tab').classList.add('active');
            
            document.getElementById('currentChapterTitle').textContent = `${chapter.title} - Quiz Questions`;
            document.getElementById('currentQuizContent').style.display = 'block';
            
            renderQuizQuestions(chapterId);
        };

        function renderQuizQuestions(chapterId) {
            const questionsElement = document.getElementById('quizQuestions');
            const questions = chapterQuizzes[chapterId] || [];
            
            if (questions.length === 0) {
                questionsElement.innerHTML = `
                    <div class="alert alert-info text-center">
                        <p class="mb-2">No questions added yet for this chapter.</p>
                        <button class="btn btn-primary" onclick="addQuizQuestion()">Add First Question</button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            questions.forEach((question, index) => {
                html += createQuestionHtml(index + 1, question);
            });
            
            questionsElement.innerHTML = html;
        }

        window.addQuizQuestion = function() {
            if (!currentQuizChapter) {
                alert('Please select a chapter first');
                return;
            }
            
            if (!chapterQuizzes[currentQuizChapter]) {
                chapterQuizzes[currentQuizChapter] = [];
            }
            
            const newQuestion = {
                question: '',
                options: ['', '', '', ''],
                correctAnswer: 0
            };
            
            chapterQuizzes[currentQuizChapter].push(newQuestion);
            renderQuizQuestions(currentQuizChapter);
            updateQuizSummary();
            generateChapterQuizTabs();
        };

        window.removeQuizQuestion = function(questionIndex) {
            if (!currentQuizChapter) return;
            
            if (chapterQuizzes[currentQuizChapter].length <= 3) {
                alert('Minimum 3 questions required per chapter');
                return;
            }
            
            chapterQuizzes[currentQuizChapter].splice(questionIndex, 1);
            renderQuizQuestions(currentQuizChapter);
            updateQuizSummary();
            generateChapterQuizTabs();
        };

        function createQuestionHtml(questionNum, questionData) {
            return `
                <div class="question-block mb-4 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Question ${questionNum}</h6>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeQuizQuestion(${questionNum - 1})">
                            Remove
                        </button>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control question-input" 
                               placeholder="Enter your question..." 
                               value="${questionData.question}"
                               onchange="updateQuestionData(${questionNum - 1}, 'question', this.value)" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-2" 
                                   placeholder="Option A (Correct Answer)" 
                                   value="${questionData.options[0]}"
                                   onchange="updateQuestionData(${questionNum - 1}, 'option', this.value, 0)" required>
                            <input type="text" class="form-control mb-2" 
                                   placeholder="Option B" 
                                   value="${questionData.options[1]}"
                                   onchange="updateQuestionData(${questionNum - 1}, 'option', this.value, 1)">
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-2" 
                                   placeholder="Option C" 
                                   value="${questionData.options[2]}"
                                   onchange="updateQuestionData(${questionNum - 1}, 'option', this.value, 2)">
                            <input type="text" class="form-control mb-2" 
                                   placeholder="Option D" 
                                   value="${questionData.options[3]}"
                                   onchange="updateQuestionData(${questionNum - 1}, 'option', this.value, 3)">
                        </div>
                    </div>
                    <small class="text-muted">üí° The first option will be marked as the correct answer</small>
                </div>
            `;
        }

        window.updateQuestionData = function(questionIndex, type, value, optionIndex = null) {
            if (!currentQuizChapter) return;
            
            const questions = chapterQuizzes[currentQuizChapter];
            if (!questions[questionIndex]) return;
            
            if (type === 'question') {
                questions[questionIndex].question = value;
            } else if (type === 'option' && optionIndex !== null) {
                questions[questionIndex].options[optionIndex] = value;
            }
        };

        // Summary functions
        function updateSummary() {
            const title = document.getElementById('bookTitle').value || 'Enter book title';
            const author = document.getElementById('bookAuthor').value || 'Enter author';
            const bonus = parseFloat(document.getElementById('completionBonus').value) || 5.00;
            const score = document.getElementById('passingScore').value || '80';
            
            const chapterRewards = chapters.reduce((sum, ch) => sum + ch.reward, 0);
            const totalRewards = chapterRewards + bonus;

            document.getElementById('summaryTitle').textContent = title;
            document.getElementById('summaryAuthor').textContent = author;
            document.getElementById('summaryChapters').textContent = chapters.length;
            document.getElementById('summaryChapterRewards').textContent = chapterRewards.toFixed(2);
            document.getElementById('summaryBonus').textContent = bonus.toFixed(2);
            document.getElementById('summaryTotal').textContent = totalRewards.toFixed(2);
            document.getElementById('summaryScore').textContent = score + '%';
            
            updateQuizSummary();
        }

        function updateQuizSummary() {
            const summaryElement = document.getElementById('quizSummary');
            
            if (chapters.length === 0) {
                summaryElement.innerHTML = 'No chapters added yet';
                return;
            }
            
            let summary = '';
            let totalQuestions = 0;
            
            chapters.forEach(chapter => {
                const questionsCount = chapterQuizzes[chapter.id] ? chapterQuizzes[chapter.id].length : 0;
                totalQuestions += questionsCount;
                
                const status = questionsCount >= 3 ? '‚úÖ' : '‚è≥';
                summary += `${status} ${chapter.title}: ${questionsCount} questions<br>`;
            });
            
            summary += `<strong>Total Questions: ${totalQuestions}</strong>`;
            summaryElement.innerHTML = summary;
        }

        // DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Add Book page loaded with Firebase integration!');
            updateSummary();
            
            // Add event listeners for real-time updates
            document.getElementById('bookTitle').addEventListener('input', updateSummary);
            document.getElementById('bookAuthor').addEventListener('input', updateSummary);
            document.getElementById('completionBonus').addEventListener('input', updateSummary);
            document.getElementById('passingScore').addEventListener('change', updateSummary);
        });

    </script>
</body>
</html>